{"version":3,"sources":["../src/asyncOperationManagerUtils.js"],"names":["getAsyncOperationsManagerState","asyncOperationManagerState","getState","clearAsyncOperationsManagerState","clearState","setAsyncOperationsManagerState","setState","registerAsyncOperationDescriptors","asyncOperationDescriptors","newState","state","config","asyncOperationManagerConfig","getConfig","otherDescriptors","logger","exceptionsCallback","Error","acc","asyncOperationDescriptor","asyncOperationStateUtils","updateAsyncOperationDescriptor","invalidateAsyncOperation","descriptorId","params","createInvalidatedOperationState","getAsyncOperation","otherFields","descriptors","asyncOperationParams","asyncOperationKey","getAsyncOperationFromState","fieldsToAdd","shouldRunOperation","asyncOperation","operationType","ASYNC_OPERATION_TYPES","READ","fetchStatus","FETCH_STATUS","NULL","Date","now","lastFetchStatusTime","minCacheTime","readStepLookup","ASYNC_OPERATION_STEPS","BEGIN_ASYNC_OPERATION","RESOLVE_ASYNC_OPERATION","REJECT_ASYNC_OPERATION","writeStepLookup","transformTypeLookup","asyncOperationStep","WRITE","getStateForOperationAfterStep","onBegin","onResolve","onReject","asyncOperationToTranform","newAsyncOperation","updateAsyncOperation"],"mappings":"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","sourcesContent":["// TODO: JSDocify every function\n\n// \n// This file contains the 'switchboard' logic to coordinate the various\n// lower-level functions that update state. These functions are exposed\n// to the consumer of the library.\n//\n\nimport {\n  isArray,\n  isEmpty,\n  reduce,\n} from 'lodash';\n\nimport asyncOperationStateUtils from './asyncOperationStateUtils';\nimport asyncOperationManagerConfig from './config';\nimport { asyncOperationManagerState } from './asyncOperationManagerState';\n\nimport {\n  beginReadAsyncOperation,\n  beginWriteAsyncOperation,\n  resolveReadAsyncOperation,\n  resolveWriteAsyncOperation,\n  rejectReadAsyncOperation,\n  rejectWriteAsyncOperation,\n} from './asyncOperationUtils';\n\nimport {\n  getAsyncOperationInfo,\n} from './helpers';\n\nimport {\n  ASYNC_OPERATION_TYPES,\n  ASYNC_OPERATION_STEPS,\n  FETCH_STATUS,\n} from './constants';\n\nconst getAsyncOperationsManagerState = asyncOperationManagerState.getState;\nconst clearAsyncOperationsManagerState = asyncOperationManagerState.clearState;\nconst setAsyncOperationsManagerState = asyncOperationManagerState.setState;\n\nconst registerAsyncOperationDescriptors = (asyncOperationDescriptors, ...otherDescriptors) => {\n  let newState;\n  const state = getAsyncOperationsManagerState();\n  const config = asyncOperationManagerConfig.getConfig();\n\n  if (!isEmpty(otherDescriptors)) {\n    config.logger.exceptionsCallback(`\n      You provided more than one argument to registerAsyncOperationDescriptors.\n      You likely forgot to put multiple descriptors within an array`, new Error());\n  }\n  // handle array or single object arguments\n  if (isArray(asyncOperationDescriptors)) {\n    newState = reduce(asyncOperationDescriptors, (acc, asyncOperationDescriptor) => {\n      return asyncOperationStateUtils.updateAsyncOperationDescriptor(acc, asyncOperationDescriptor);\n    }, state);\n  } else {\n    newState = asyncOperationStateUtils.updateAsyncOperationDescriptor(state, asyncOperationDescriptors);\n  }\n\n  return asyncOperationManagerState.setState(newState);\n};\n\nconst invalidateAsyncOperation = (descriptorId, params) => {\n  const state = getAsyncOperationsManagerState();\n  const newState = asyncOperationStateUtils.createInvalidatedOperationState(state, descriptorId, params);\n  return asyncOperationManagerState.setState(newState);\n};\n\nconst getAsyncOperation = (\n  state,\n  descriptorId,\n  params,\n  otherFields,\n) => {\n  const {\n    asyncOperationDescriptor,\n    asyncOperationParams,\n    asyncOperationKey,\n  } = getAsyncOperationInfo(state.descriptors, descriptorId, params);\n\n  // in case operation/descriptor state is initialized in userland we pass that through\n  // to the library state.\n  const newState = asyncOperationManagerState.setState(state);\n\n  return asyncOperationStateUtils.getAsyncOperationFromState({\n    state: newState,\n    asyncOperationKey,\n    asyncOperationDescriptor,\n    asyncOperationParams,\n    fieldsToAdd: otherFields,\n  });\n};\n\nconst shouldRunOperation = (descriptorId, params) => {\n  const state = asyncOperationManagerState.getState();\n\n  const {\n    asyncOperationDescriptor,\n    asyncOperationParams,\n  } = getAsyncOperationInfo(state.descriptors, descriptorId, params);\n\n  const asyncOperation = getAsyncOperation(\n    state,\n    descriptorId,\n    asyncOperationParams,\n  );\n\n  if (asyncOperationDescriptor.operationType === ASYNC_OPERATION_TYPES.READ && asyncOperation.fetchStatus !== FETCH_STATUS.NULL) {\n    return (Date.now() - asyncOperation.lastFetchStatusTime) >= asyncOperationDescriptor.minCacheTime;\n  }\n\n  return true;\n};\n\n// switchboard for resolving the Read operation steps\nconst readStepLookup = {\n  [ASYNC_OPERATION_STEPS.BEGIN_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => beginReadAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_STEPS.RESOLVE_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => resolveReadAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_STEPS.REJECT_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => rejectReadAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n};\n\n// switchboard for resolving Write operation steps\nconst writeStepLookup = {\n  [ASYNC_OPERATION_STEPS.BEGIN_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => beginWriteAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_STEPS.RESOLVE_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => resolveWriteAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_STEPS.REJECT_ASYNC_OPERATION]:\n    (asyncOperation, asyncOperationParams, otherFields) => rejectWriteAsyncOperation(asyncOperation, asyncOperationParams, otherFields),\n};\n\n// first switchboard to transform an async operation\nconst transformTypeLookup = {\n  [ASYNC_OPERATION_TYPES.READ]:\n    (asyncOperation, asyncOperationStep, asyncOperationParams, otherFields) => readStepLookup[asyncOperationStep](asyncOperation, asyncOperationParams, otherFields),\n  [ASYNC_OPERATION_TYPES.WRITE]:\n    (asyncOperation, asyncOperationStep, asyncOperationParams, otherFields) => writeStepLookup[asyncOperationStep](asyncOperation, asyncOperationParams, otherFields),\n};\n\n// this function is called in the reducer (in redux integration)\nconst getStateForOperationAfterStep = (state, asyncOperationStep, descriptorId, params) => {\n  // in case operation/descriptor state is initialized in userland we pass that through\n  // to the library state.\n  let newState = setAsyncOperationsManagerState(state);\n\n  const {\n    asyncOperationDescriptor,\n    asyncOperationParams,\n    asyncOperationKey,\n    otherFields,\n  } = getAsyncOperationInfo(newState.descriptors, descriptorId, params);\n\n  // descriptor asyncOperationStep callbacks\n  if (asyncOperationDescriptor.onBegin && asyncOperationStep === ASYNC_OPERATION_STEPS.BEGIN_ASYNC_OPERATION) {\n    asyncOperationDescriptor.onBegin(asyncOperationParams);\n  }\n  if (asyncOperationDescriptor.onResolve && asyncOperationStep === ASYNC_OPERATION_STEPS.RESOLVE_ASYNC_OPERATION) {\n    asyncOperationDescriptor.onResolve(asyncOperationParams);\n  }\n  if (asyncOperationDescriptor.onReject && asyncOperationStep === ASYNC_OPERATION_STEPS.REJECT_ASYNC_OPERATION) {\n    asyncOperationDescriptor.onReject(asyncOperationParams);\n  }\n\n  // If any of the asyncOperationStep callbacks changed the state we want to grab the latest state\n  newState = getAsyncOperationsManagerState();\n\n  const asyncOperationToTranform = getAsyncOperation(\n    newState,\n    descriptorId,\n    asyncOperationParams,\n    otherFields,\n  );\n\n  const newAsyncOperation = transformTypeLookup[asyncOperationDescriptor.operationType](asyncOperationToTranform, asyncOperationStep, asyncOperationParams, otherFields);\n\n  newState = asyncOperationStateUtils.updateAsyncOperation(newState, asyncOperationKey, newAsyncOperation, asyncOperationDescriptor);\n\n  return asyncOperationManagerState.setState(newState);\n};\n\nexport {\n  getAsyncOperationsManagerState,\n  clearAsyncOperationsManagerState,\n  setAsyncOperationsManagerState,\n\n  getAsyncOperation,\n  invalidateAsyncOperation,\n  registerAsyncOperationDescriptors,\n  getStateForOperationAfterStep,\n\n  shouldRunOperation,\n};\n"],"file":"asyncOperationManagerUtils.js"}