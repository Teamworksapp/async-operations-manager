{"version":3,"sources":["../src/asyncOperationStateUtils.js"],"names":["updateAsyncOperationDescriptor","state","descriptorOptions","asyncOperationDescriptor","debug","parentOperationDescriptorId","invalidatingOperationsDescriptorIds","alwaysImmutable","minCacheTime","maxCacheTime","requiredParams","PropTypes","checkPropTypes","asyncOperationDescriptorPropType","descriptors","descriptorId","createInvalidatedOperationState","params","nonWildcardParams","param","WILDCARD","matchingDescriptorIdOperations","operations","operation","invalidatedOperations","acc","paramMatchCount","invalidatedOperation","value","key","length","operationType","ASYNC_OPERATION_TYPES","READ","invalidatedOperationsState","getAsyncOperationFromState","asyncOperationKey","asyncOperationParams","fieldsToAdd","parentAsyncOperation","asyncOperation","config","asyncOperationManagerConfig","getConfig","fieldsToAddToAction","logger","verboseLoggingCallback","infoLoggingCallback","parentAsyncOperationDescriptor","parentAsyncOperationKey","lastDataStatusTime","valueOf","readAsyncOperationFieldsToPullFromParent","updateAsyncOperation","asyncOperationPropType","updatedOperationsState","bulkUpdateAsyncOperations","asyncOperationsList","accumulator"],"mappings":"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","sourcesContent":["\n// TODO: JSDocify every function\nimport {\n  pick,\n  reduce,\n  omitBy,\n  forIn,\n  get,\n  keys,\n  filter,\n  isEmpty,\n} from 'lodash';\nimport PropTypes from 'prop-types';\n\nimport asyncOperationManagerConfig from './config';\n\nimport {\n  ASYNC_OPERATION_TYPES,\n  WILDCARD,\n  readAsyncOperationFieldsToPullFromParent,\n} from './constants';\n\nimport {\n  getAsyncOperationInfo,\n} from './helpers';\n\nimport {\n  asyncOperationDescriptorPropType,\n  asyncOperationPropType,\n} from './types';\n\nimport {\n  initialReadAsyncOperationForAction,\n  initialWriteAsyncOperationForAction,\n} from './asyncOperationUtils';\n\n// // //\n// // // These are all pure functions that return new or existing state or\n// // // pieces of new or existing state from their inputs.\n// // //\n\nconst updateAsyncOperationDescriptor = (state, descriptorOptions) => {\n  const asyncOperationDescriptor = {\n    debug: false,\n    parentOperationDescriptorId: null,\n    invalidatingOperationsDescriptorIds: null,\n    alwaysImmutable: false,\n    minCacheTime: 5000,\n    maxCacheTime: 60000,\n    requiredParams: {},\n    ...descriptorOptions,\n  };\n\n  PropTypes.checkPropTypes(asyncOperationDescriptorPropType, asyncOperationDescriptor, 'prop', 'asyncOperationDescriptor');\n  \n  return {\n    ...state,\n    descriptors: {\n      ...state.descriptors,\n      [asyncOperationDescriptor.descriptorId]: asyncOperationDescriptor,\n    },\n  };\n};\n\nconst createInvalidatedOperationState = (state, descriptorId, params) => {\n  const nonWildcardParams = omitBy(params, param => param === WILDCARD);\n  const matchingDescriptorIdOperations = filter(state.operations, operation => operation.descriptorId === descriptorId);\n\n  if (isEmpty(matchingDescriptorIdOperations)) {\n    return state;\n  }\n\n  const {\n    asyncOperationDescriptor,\n  } = getAsyncOperationInfo(state.descriptors, descriptorId, params);\n\n  const invalidatedOperations = reduce(matchingDescriptorIdOperations, (acc, operation) => {\n    let paramMatchCount = 0;\n    let invalidatedOperation;\n    forIn(nonWildcardParams, (value, key) => {\n      if (get(operation.params, key) === value) {\n        paramMatchCount += 1;\n        if (paramMatchCount === keys(nonWildcardParams).length) {\n          invalidatedOperation = {\n            [operation.key]: {\n              ...operation,\n              ...asyncOperationDescriptor.operationType === ASYNC_OPERATION_TYPES.READ\n                ? initialReadAsyncOperationForAction(asyncOperationDescriptor.descriptorId, operation.params, operation.key)\n                : initialWriteAsyncOperationForAction(asyncOperationDescriptor.descriptorId, operation.params, operation.key),\n            },\n          };\n        }\n      }\n      return true;\n    });\n\n    if (invalidatedOperation) {\n      return {\n        ...acc,\n        ...invalidatedOperation,\n      };\n    }\n\n    return acc;\n  }, {});\n\n  const invalidatedOperationsState = {\n    ...state,\n    operations: {\n      ...state.operations,\n      ...invalidatedOperations,\n    },\n  };\n\n  return invalidatedOperationsState;\n};\n\n// This function will do all the work to determine if an async operation is returned as an initial async operation\n// (if it is not found in state), an asyncOperation with parentAsyncOperation metaData (recursively searched to find if the parentAsyncOperation is more\n// up-to-date) or just the asyncOperation itself if the none of the above apply.\nconst getAsyncOperationFromState = ({\n  state,\n  asyncOperationKey,\n  asyncOperationDescriptor,\n  asyncOperationParams,\n  fieldsToAdd,\n}) => {\n  const { operations, descriptors } = state;\n\n  let parentAsyncOperation;\n  const asyncOperation = operations[asyncOperationKey] || null;\n\n  const config = asyncOperationManagerConfig.getConfig();\n  const fieldsToAddToAction = {\n    ...asyncOperationParams,\n    ...fieldsToAdd,\n    // key for the descriptor of the asyncOperation\n    descriptorId: asyncOperationDescriptor.descriptorId,\n  };\n\n  if (asyncOperationDescriptor.debug) {\n    config.logger.verboseLoggingCallback(`Inside getAsyncOperation for ${asyncOperationKey}`);\n    config.logger.infoLoggingCallback('getAsyncOperation [Data Snapshot]:', {\n      state,\n      asyncOperationParams,\n      asyncOperationDescriptor,\n      asyncOperation,\n      asyncOperationKey,\n    });\n  }\n\n  if (asyncOperationDescriptor.parentOperationDescriptorId) {\n    // grab key, descriptor, params, and async operation for parentAsyncOperation\n    const {\n      asyncOperationDescriptor: parentAsyncOperationDescriptor,\n      asyncOperationKey: parentAsyncOperationKey,\n    } = getAsyncOperationInfo(descriptors, asyncOperationDescriptor.parentOperationDescriptorId, asyncOperationParams);\n\n    if (parentAsyncOperationDescriptor.operationType === ASYNC_OPERATION_TYPES.READ) {\n      parentAsyncOperation = getAsyncOperationFromState({\n        state,\n        asyncOperationKey: parentAsyncOperationKey,\n        asyncOperationDescriptor: parentAsyncOperationDescriptor,\n        asyncOperationParams,\n        fieldsToAdd: fieldsToAddToAction,\n      });\n    }\n  }\n\n  if (!asyncOperation) {\n    if (asyncOperationDescriptor.debug) {\n      config.logger.verboseLoggingCallback(`asyncOperation not found with given key: ${asyncOperationKey}. Defaulting to an initial asyncOperation`);\n    }\n    return asyncOperationDescriptor.operationType === ASYNC_OPERATION_TYPES.READ\n      ? initialReadAsyncOperationForAction(asyncOperationDescriptor.descriptorId, asyncOperationParams, asyncOperationKey, fieldsToAddToAction, parentAsyncOperation)\n      : initialWriteAsyncOperationForAction(asyncOperationDescriptor.descriptorId, asyncOperationParams, asyncOperationKey, fieldsToAddToAction, parentAsyncOperation);\n  }\n\n  // We want to determine whether or not to use that parentAsyncOperation metaData based on the\n  // newness of it's data in comparison to the asyncOperation\n  if (parentAsyncOperation) {\n    return parentAsyncOperation.lastDataStatusTime.valueOf() >= asyncOperation.lastDataStatusTime.valueOf()\n      ? {\n        ...asyncOperation,\n        // use parent async operation metaData (lastDataStatusTime, lastFetchStatusTime. etc...)\n        ...pick(parentAsyncOperation, readAsyncOperationFieldsToPullFromParent),\n      }\n      : asyncOperation;\n  }\n\n  return asyncOperation;\n};\n\nconst updateAsyncOperation = ({\n  state,\n  asyncOperation,\n  params,\n  descriptorId,\n}) => {\n  const {\n    asyncOperationDescriptor,\n    asyncOperationKey,\n  } = getAsyncOperationInfo(state.descriptors, descriptorId, params);\n\n  const config = asyncOperationManagerConfig.getConfig();\n  if (asyncOperationDescriptor.debug) {\n    config.logger.verboseLoggingCallback(`Inside updateAsyncOperation for ${asyncOperationKey}`);\n    config.logger.infoLoggingCallback('updateAsyncOperation [Data Snapshot]:', {\n      asyncOperationDescriptor,\n      asyncOperation,\n      asyncOperationKey,\n    });\n  }\n\n  PropTypes.checkPropTypes(asyncOperationPropType, asyncOperation, 'prop', 'asyncOperation');\n\n  const updatedOperationsState = {\n    operations: {\n      ...state.operations,\n      [asyncOperationKey]: {\n        ...asyncOperation,\n        params,\n        key: asyncOperationKey,\n      },\n    },\n  };\n\n  return updatedOperationsState;\n};\n\nconst bulkUpdateAsyncOperations = (state, asyncOperationsList) => {\n  return reduce(asyncOperationsList, (accumulator, { params, asyncOperation, descriptorId }) => {\n    return updateAsyncOperation({\n      accumulator,\n      asyncOperation,\n      params,\n      descriptorId,\n    });\n  }, state);\n};\n\nexport default {\n  updateAsyncOperationDescriptor,\n\n  updateAsyncOperation,\n  bulkUpdateAsyncOperations,\n\n  getAsyncOperationFromState,\n\n  createInvalidatedOperationState,\n};\n"],"file":"asyncOperationStateUtils.js"}